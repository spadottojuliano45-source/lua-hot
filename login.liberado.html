<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">  
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat VIP 2026 - Lilith Crow</title>
    <style>
        /* CSS ORIGINAL PRESERVADO INTEGRALMENTE */
        body { font-family: sans-serif; background-color: #0d0d0d; color: #eee; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .chat-container { display: flex; width: 100%; max-width: 900px; background: #1a1a1a; border-radius: 10px; overflow: hidden; border: 1px solid #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative; }
        .member-list { width: 250px; border-right: 1px solid #333; padding: 15px; background: #151515; overflow-y: auto; max-height: 650px; display: flex; flex-direction: column; }
        .btn-sair-chat { background: #331111; color: #ff4444; border: 1px solid #552222; padding: 10px; text-align: center; text-decoration: none; font-weight: bold; font-size: 12px; border-radius: 4px; margin-bottom: 20px; cursor: pointer; }
        .member-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #222; font-size: 14px; }
        .member-item.active { color: yellow; border-left: 3px solid yellow; background: #222; }
        .chat-area { flex-grow: 1; padding: 15px; display: flex; flex-direction: column; background: #111; }
        .chat-box { flex-grow: 1; overflow-y: auto; border: 1px solid #222; border-radius: 4px; padding: 15px; margin-bottom: 10px; background-color: #000; height: 380px; }
        .emoji-bar { padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; margin-bottom: 5px; display: flex; gap: 10px; flex-wrap: wrap; max-height: 70px; overflow-y: auto; }
        .emoji-item { cursor: pointer; font-size: 20px; }
        .message-input-area { display: flex; gap: 10px; align-items: center; }
        .message-input { flex-grow: 1; padding: 12px; border: 1px solid #333; border-radius: 4px; background-color: #222; color: #eee; outline: none; }
        .send-button { padding: 10px 20px; background-color: yellow; color: black; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .message { margin-bottom: 15px; border-bottom: 1px solid #111; padding-bottom: 10px; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; margin-right: 10px; vertical-align: middle; border: 1px solid yellow; }
        .current-chat-label { font-weight: bold; margin-bottom: 10px; color: yellow; font-size: 0.9em; text-transform: uppercase; }
        .admin-controls { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        .admin-button { padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 11px; border: none; font-weight: bold; }
        .msg-media { max-width: 250px; border-radius: 8px; margin-top: 10px; display: block; border: 1px solid #333; }
        #video-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        .video-btns { position: absolute; bottom: 30px; display: flex; gap: 20px; }
        .btn-end-call { width: 55px; height: 55px; border-radius: 50%; border: none; cursor: pointer; background: #ff4444; color: white; font-size: 22px; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="chat-container">
        <div id="video-overlay">
            <video id="webcam" autoplay playsinline></video>
            <div class="video-btns">
                <button class="btn-end-call" onclick="pararChamada()">üìû</button>
            </div>
        </div>

        <div class="member-list" id="member-list">
            <!-- Bot√£o de Sair/Logout -->
            <a href="javascript:void(0)" class="btn-sair-chat" onclick="logout()">VOLTAR AO SITE (SAIR)</a>
            <div class="member-item active" id="item-general" onclick="openChat('general', 'Chat Geral')">üåê Chat Geral</div>
        </div>

        <div class="chat-area">
            <div class="current-chat-label" id="chat-title">Conversando com: Chat Geral</div>
            <div id="chat-box" class="chat-box"></div>
            
            <div class="emoji-bar">
                <span class="emoji-item" onclick="addEmoji('üòä')">üòä</span><span class="emoji-item" onclick="addEmoji('üòà')">üòà</span>
                <span class="emoji-item" onclick="addEmoji('üî•')">üî•</span><span class="emoji-item" onclick="addEmoji('üîû')">üîû</span>
                <span class="emoji-item" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span><span class="emoji-item" onclick="addEmoji('ü§´')">ü§´</span>
            </div>

            <div class="message-input-area">
                <input type="text" id="message-input" class="message-input" placeholder="Digite sua mensagem...">
                <button onclick="sendMessage()" class="send-button">ENVIAR</button>
            </div>

            <div class="admin-controls">
                <input type="file" id="file-up" accept="image/*,video/*" style="display: none;" onchange="sendMedia(event)">
                <button class="admin-button" style="background:#333; color:white;" onclick="document.getElementById('file-up').click()">üìÅ M√≠dia</button>
                <button id="mic-btn" class="admin-button" style="background:#005500; color:white;" onclick="toggleMic()">üé§ √Åudio</button>
                <button class="admin-button" style="background:#004488; color:white;" onclick="chamarVideo()">üìπ V√≠deo</button>
                <button id="btn-clean" class="admin-button" style="background:#444; color:#ff4444; display:none;" onclick="clearHistory()">üóëÔ∏è Limpar</button>
            </div>
        </div>
    </div>

    <!-- SUPABASE CORE 2026 CORRIGIDO -->
    <script src="cdn.jsdelivr.net"></script>
    <script>
        const SUPABASE_URL = 'https://lcdwunihbqeozqypsyko.supabase.co';
        // Sua chave public√°vel foi inserida aqui:
        const SUPABASE_KEY = 'sb_publishable_NwWEjJuRPr1Fe-826bS_BQ_bp4NwhJ7'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const imgAvatar = "fotos/imagens/00011.jpg";
        let activeId = 'general';
        let recorder;
        let chunks = [];

        let isAdmin = false;
        let usuarioNome = "Membro VIP";

        // --- FUN√á√ÉO DE VERIFICA√á√ÉO DE LOGIN (SEGURA) ---
        async function verificarLogin() {
            const { data: { session }, error } = await _supabase.auth.getSession();
            if (error || !session) {
                // Se n√£o estiver logado, redireciona imediatamente
                window.location.href = "login.html";
                return;
            }

            // Define vari√°veis globais com base na sess√£o
            usuarioNome = localStorage.getItem('nomeUsuario') || session.user.email;
            isAdmin = (session.user.email === "spadottojuliano45@gmail.com");

            // Continua carregando o chat se logado
            if(isAdmin) document.getElementById('btn-clean').style.display = 'inline-block';
            loadMessages();
            subscribeChat();
        }

        // --- FUN√á√ÉO DE LOGOUT ---
        async function logout() {
            const { error } = await _supabase.auth.signOut();
            if (!error) {
                // Limpa todos os dados de sess√£o e redireciona
                sessionStorage.clear();
                localStorage.removeItem('nomeUsuario');
                localStorage.removeItem('supabaseToken'); // Remove o token se voc√™ o estiver usando
                window.location.href = "index.html";
            } else {
                alert("Erro ao sair. Tente novamente.");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            verificarLogin(); // Inicia a verifica√ß√£o de login
            document.getElementById('message-input').addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });
        });
        
        function subscribeChat() {
            _supabase.channel('custom-all-channel')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mensagens' }, payload => {
                displayMessage(payload.new);
            })
            .subscribe();
        }

        async function loadMessages() {
            const { data, error } = await _supabase.from('mensagens').select('*').order('created_at', { ascending: true }).limit(100);
            if(!error) {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                data.forEach(msg => displayMessage(msg));
                box.scrollTop = box.scrollHeight; // Rola para o final
            }
        }

        // --- COLE AQUI O RESTANTE DAS SUAS FUN√á√ïES JAVASCRIPT ---
        // Fun√ß√µes: displayMessage, sendMessage, addEmoji, sendMedia, toggleMic, chamarVideo, pararChamada, clearHistory, openChat
        // Como n√£o foram fornecidas no chat, voc√™ precisar√° col√°-las do seu arquivo original aqui.
        // Apenas certifique-se de que onde voc√™ usa IDs (e.g., para excluir mensagens), eles sejam tratados como strings ('${m.id}') por causa do UUID.

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Lilith Crow</title>
    <style>
        /* LAYOUT ORIGINAL PRESERVADO - NÃO MEXER */
        body { font-family: Arial, sans-serif; background: #000; color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: #111; border: 1px solid #ff0000; width: 100%; max-width: 400px; border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px rgba(255,0,0,0.4); position: relative; }
        .btn-voltar-topo { position: absolute; top: 12px; left: 12px; color: #aaa; text-decoration: none; font-size: 11px; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; z-index: 10; background: #111; }
        .tabs { display: flex; background: #222; padding-top: 40px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab.active { border-bottom: 2px solid #ff0000; background: #111; }
        .content { padding: 25px; display: none; }
        .content.active { display: block; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #aaa; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #333; background: #222; color: #fff; box-sizing: border-box; outline: none; }
        .btn-acao { width: 100%; padding: 12px; border: none; border-radius: 5px; background: #ff0000; color: #fff; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.3s; }
        .btn-cancelar { width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: transparent; color: #aaa; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; box-sizing: border-box; font-size: 14px; }
        .pix-box { margin-top: 15px; padding: 12px; border: 1px dashed #444; border-radius: 5px; font-size: 13px; background: #1a1a1a; line-height: 1.5; }
        .status-msg { margin-top: 15px; font-size: 14px; text-align: center; font-weight: bold; line-height: 1.4; }
        #img-oferta { width: 100%; margin-bottom: 15px; border-radius: 5px; display: none; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="card">
    <a href="index.html" class="btn-voltar-topo">← VOLTAR</a>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(event, 'tab-login')">LOGIN</div>
        <div class="tab" onclick="switchTab(event, 'tab-cadastro')">CADASTRO</div>
    </div>

    <!-- LOGIN -->
    <div id="tab-login" class="content active">
        <form id="form-login">
            <label>Email ou Usuário:</label>
            <input type="text" id="login-email" required>
            <label>Senha:</label>
            <input type="password" id="login-pass" required>
            <button type="submit" class="btn-acao">ENTRAR</button>
            <a href="index.html" class="btn-cancelar">CANCELAR</a>
        </form>
    </div>

    <!-- CADASTRO -->
    <div id="tab-cadastro" class="content">
        <img src="" id="img-oferta" alt="Oferta Especial">
        <form id="form-cadastro">
            <label>Nome de Usuário:</label>
            <input type="text" name="usuario" id="reg-usuario" required>
            <label>Email:</label>
            <input type="email" name="email" id="reg-email" required>
            <label>Crie sua Senha:</label>
            <input type="password" name="senha" id="reg-pass" required>

            <div class="pix-box">
                <strong style="color: #ff0000;">PAGAMENTO:</strong> Realize o PIX para o CPF:<br>
                <span id="txt-chave" style="color:#00ff00; font-size: 15px; font-weight: bold;">307.759.588,59</span><br>
                Valor: <span id="txt-valor" style="color:#00ff00; font-weight:bold;">A combinar</span><br>
                Mande o print para: <strong>(14) 99869-9358</strong>
            </div>
            <br>
            <button id="btn-cadastro-submit" type="submit" class="btn-acao">ENVIAR CADASTRO</button>
            <a href="index.html" class="btn-cancelar">CANCELAR</a>
            <div id="status-cadastro" class="status-msg"></div>
        </form>
    </div>
</div>

<!-- Scripts Supabase CORRIGIDOS 2026 -->
<script src="cdn.jsdelivr.net"></script>
<script>
    // Configurações Reais 2026
    const SUPABASE_URL = 'https://lcdwunihbqeozqypsyko.supabase.co';
    // Sua chave publicável foi inserida aqui:
    const SUPABASE_KEY = 'sb_publishable_NwWEjJuRPr1Fe-826bS_BQ_bp4NwhJ7'; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Sincronização de valores do PIX
    function atualizarValoresDinamicos() {
        const valorSalvo = localStorage.getItem('valorPixAtivo');
        const chaveSalva = localStorage.getItem('chavePixAtiva');
        const fotoSalva = localStorage.getItem('fotoValorAtiva');
        if(valorSalvo) document.getElementById('txt-valor').innerText = "R$ " + valorSalvo;
        if(chaveSalva) document.getElementById('txt-chave').innerText = chaveSalva;
        const imgOferta = document.getElementById('img-oferta');
        if(fotoSalva && fotoSalva.trim() !== "") { imgOferta.src = fotoSalva; imgOferta.style.display = "block"; }
    }
    window.onload = atualizarValoresDinamicos;

    function switchTab(event, tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // --- LÓGICA DE LOGIN (AGORA SEGURO COM SUPABASE AUTH) ---
    document.getElementById('form-login').onsubmit = async function(e) {
        e.preventDefault();
        const emailInput = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value.trim();

        // Login da Admin hardcoded (mantido como exceção do usuário)
        if (emailInput === "spadottojuliano45@gmail.com" && pass === "136408ju") {
            sessionStorage.setItem('logadoAdmin', 'true');
            localStorage.setItem('nomeUsuario', 'Lua - Hot');
            window.location.href = "admin.html";
            return;
        }

        // Login do Membro via Supabase Auth
        const { data: authData, error: authError } = await _supabase.auth.signInWithPassword({
            email: emailInput, // O Auth usa o e-mail como login principal
            password: pass,
        });

        if (authError) {
            alert("Acesso negado. Verifique seu e-mail e senha.");
            return;
        }

        // Se o login Auth for bem-sucedido, verifique se o membro está 'aprovado' na sua tabela 'membros'
        if (authData.user) {
            const { data: membroData, error: membroError } = await _supabase
                .from('membros')
                .select('*')
                .eq('id', authData.user.id) // Use o ID seguro do Auth para buscar o perfil
                .single();

            if (membroError || !membroData) {
                alert("Erro ao encontrar seu perfil. Contate o suporte.");
                await _supabase.auth.signOut(); // Desloga o usuário automaticamente
                return;
            }

            if (!membroData.aprovado) {
                alert("Sua conta está aguardando aprovação de pagamento!");
                await _supabase.auth.signOut(); // Desloga o usuário automaticamente
                return;
            } else {
                // Logado e aprovado com sucesso!
                localStorage.setItem('supabaseToken', authData.session.access_token); // Armazena o token
                localStorage.setItem('nomeUsuario', membroData.usuario);
                window.location.href = "login.liberado.html";
            }
        }
    };

    // --- LÓGICA DE CADASTRO (AGORA SEGURO COM SUPABASE AUTH) ---
    const formCad = document.getElementById("form-cadastro");
    formCad.onsubmit = async function(event) {
        event.preventDefault(); 
        const status = document.getElementById("status-cadastro");
        const button = document.getElementById("btn-cadastro-submit");
        
        button.disabled = true;
        button.innerText = "Enviando...";

        const email = document.getElementById('reg-email').value.trim();
        const senha = document.getElementById('reg-pass').value.trim();
        const usuario = document.getElementById('reg-usuario').value.trim();

        // 1. Registrar no sistema de autenticação (supa-auth)
        const { data: authData, error: authError } = await _supabase.auth.signUp({
            email: email,
            password: senha,
        });

        if (authError) {
            console.error("Erro Supabase Auth:", authError);
            status.innerHTML = `<span style='color:red'>Erro no cadastro: ${authError.message}.</span>`;
            button.disabled = false;
            button.innerText = "ENVIAR CADASTRO";
            return;
        }

        // 2. Se o Auth for OK, insira os dados públicos na tabela 'membros'
        if (authData.user) {
            const novoMembro = {
                id: authData.user.id, // CRÍTICO: use o ID do Auth como ID do membro
                usuario: usuario,
                email: email,
                aprovado: false
                // Não armazene a senha aqui!
            };

            const { error: insertError } = await _supabase.from('membros').insert([novoMembro]);

            if (insertError) {
                console.error("Erro ao inserir membro:", insertError);
                status.innerHTML = "<span style='color:red'>Erro ao finalizar cadastro. Tente novamente.</span>";
                // Considere deletar o usuário Auth criado aqui em caso de falha no insert
                button.disabled = false;
                button.innerText = "ENVIAR CADASTRO";
                return;
            }

            status.innerHTML = "<span style='color:#00ff00'>Cadastro enviado com sucesso!<br>Aguarde a liberação após o pagamento.</span>";
            // Limpa o formulário após sucesso
            formCad.reset(); 
            button.style.display = "none"; // Oculta o botão de cadastro após o sucesso
        }
    };
</script>
</body>
</html>

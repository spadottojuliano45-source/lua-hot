<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Lilith Crow</title>
    <style>
        /* LAYOUT ORIGINAL PRESERVADO - NÃO MEXER */
        body { font-family: Arial, sans-serif; background: #000; color: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: #111; border: 1px solid #ff0000; width: 100%; max-width: 400px; border-radius: 10px; overflow: hidden; box-shadow: 0 0 20px rgba(255,0,0,0.4); position: relative; }
        .btn-voltar-topo { position: absolute; top: 12px; left: 12px; color: #aaa; text-decoration: none; font-size: 11px; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; z-index: 10; background: #111; }
        .tabs { display: flex; background: #222; padding-top: 40px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab.active { border-bottom: 2px solid #ff0000; background: #111; }
        .content { padding: 25px; display: none; }
        .content.active { display: block; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #aaa; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #333; background: #222; color: #fff; box-sizing: border-box; outline: none; }
        .btn-acao { width: 100%; padding: 12px; border: none; border-radius: 5px; background: #ff0000; color: #fff; font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.3s; }
        .btn-cancelar { width: 100%; padding: 10px; border: 1px solid #444; border-radius: 5px; background: transparent; color: #aaa; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; box-sizing: border-box; font-size: 14px; }
        .pix-box { margin-top: 15px; padding: 12px; border: 1px dashed #444; border-radius: 5px; font-size: 13px; background: #1a1a1a; line-height: 1.5; }
        .status-msg { margin-top: 15px; font-size: 14px; text-align: center; font-weight: bold; line-height: 1.4; }
        #img-oferta { width: 100%; margin-bottom: 15px; border-radius: 5px; display: none; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="card">
    <a href="index.html" class="btn-voltar-topo">← VOLTAR</a>

    <div class="tabs">
        <div class="tab active" onclick="switchTab(event, 'tab-login')">LOGIN</div>
        <div class="tab" onclick="switchTab(event, 'tab-cadastro')">CADASTRO</div>
    </div>

    <!-- LOGIN -->
    <div id="tab-login" class="content active">
        <form id="form-login">
            <label>Email ou Usuário:</label>
            <input type="text" id="login-email" required>
            <label>Senha:</label>
            <input type="password" id="login-pass" required>
            <button type="submit" class="btn-acao">ENTRAR</button>
            <a href="index.html" class="btn-cancelar">CANCELAR</a>
        </form>
    </div>

    <!-- CADASTRO -->
    <div id="tab-cadastro" class="content">
        <img src="" id="img-oferta" alt="Oferta Especial">
        <form id="form-cadastro">
            <label>Nome de Usuário:</label>
            <input type="text" name="usuario" id="reg-usuario" required>
            <label>Email:</label>
            <input type="email" name="email" id="reg-email" required>
            <label>Crie sua Senha:</label>
            <input type="password" name="senha" id="reg-pass" required>

            <div class="pix-box">
                <strong style="color: #ff0000;">PAGAMENTO:</strong> Realize o PIX para o CPF:<br>
                <span id="txt-chave" style="color:#00ff00; font-size: 15px; font-weight: bold;">307.759.588,59</span><br>
                Valor: <span id="txt-valor" style="color:#00ff00; font-weight:bold;">A combinar</span><br>
                Mande o print para: <strong>(14) 99869-9358</strong>
            </div>
            <br>
            <button id="btn-cadastro-submit" type="submit" class="btn-acao">ENVIAR CADASTRO</button>
            <a href="index.html" class="btn-cancelar">CANCELAR</a>
            <div id="status-cadastro" class="status-msg"></div>
        </form>
    </div>
</div>

<!-- Scripts Supabase CORRIGIDOS 2026 -->
<script src="cdn.jsdelivr.net"></script>
<script>
    // Configurações Reais 2026
    const SUPABASE_URL = 'https://lcdwunihbqeozqypsyko.supabase.co';
    // Sua chave publicável (corrigida do seu código original que estava incompleto)
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjZHd1bmloYnFlb3pxeXBzeWtvIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODI3NjgzNywiZXhwIjoyMDgzODUyODM3fQ.XukvV_Pqe6YbJP7FWi4R_O2MTLhw6sV-w2AnQ-nTWsk'; 
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Sincronização de valores do PIX
    function atualizarValoresDinamicos() {
        const valorSalvo = localStorage.getItem('valorPixAtivo');
        const chaveSalva = localStorage.getItem('chavePixAtiva');
        const fotoSalva = localStorage.getItem('fotoValorAtiva');
        if(valorSalvo) document.getElementById('txt-valor').innerText = "R$ " + valorSalvo;
        if(chaveSalva) document.getElementById('txt-chave').innerText = chaveSalva;
        const imgOferta = document.getElementById('img-oferta');
        if(fotoSalva && fotoSalva.trim() !== "") { imgOferta.src = fotoSalva; imgOferta.style.display = "block"; }
    }
    window.onload = atualizarValoresDinamicos;

    function switchTab(event, tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // --- LÓGICA DE LOGIN (AGORA SEGURO COM SUPABASE AUTH) ---
    document.getElementById('form-login').onsubmit = async function(e) {
        e.preventDefault();
        const emailInput = document.getElementById('login-email').value.trim();
        const pass = document.getElementById('login-pass').value.trim();

        // 1. Login do Admin (Hardcoded mantido como exceção)
        if (emailInput === "spadottojuliano45@gmail.com" && pass === "136408ju") {
            sessionStorage.setItem('logadoAdmin', 'true');
            localStorage.setItem('nomeUsuario', 'Lua - Hot');
            window.location.href = "admin.html"; // REDIRECIONA PARA ADMIN.HTML
            return;
        }

        // 2. Login do Membro via Supabase Auth
        const { data: authData, error: authError } = await _supabase.auth.signInWithPassword({
            email: emailInput,
            password: pass,
        });

        if (authError) {
            alert("Acesso negado. Verifique seu e-mail e senha.");
            return;
        }

        // 3. Se o login Auth for bem-sucedido, verifique se o membro está 'aprovado' na sua tabela 'membros'
        if (authData.user) {
            const { data: membroData, error: membroError } = await _supabase
                .from('membros')
                .select('*')
                .eq('id', authData.user.id) // Use o ID seguro do Auth para buscar o perfil
                .single();

            if (membroError || !membroData) {
                // Se o usuário existe no Auth mas não na tabela "membros", desloga por segurança
                alert("Erro ao encontrar seu perfil de membro. Contate o suporte.");
                await _supabase.auth.signOut(); 
                return;
            }

            if (!membroData.aprovado) {
                alert("Sua conta está aguardando aprovação de pagamento!");
                await _supabase.auth.signOut(); 
                return;
            } else {
                // Logado e aprovado com sucesso!
                sessionStorage.setItem('logadoMembro', 'true'); // Define a flag de membro
                localStorage.setItem('nomeUsuario', membroData.usuario);
                window.location.href = "index.html"; // REDIRECIONA PARA A INDEX (QUE LIBERA LINKS)
            }
        }
    };

    // --- LÓGICA DE CADASTRO (COMPLETA COM SUPABASE AUTH E INSERÇÃO DE MEMBRO) ---
    const formCad = document.getElementById("form-cadastro");
    formCad.onsubmit = async function(event) {
        event.preventDefault();
        const usuario = document.getElementById("reg-usuario").value.trim();
        const email = document.getElementById("reg-email").value.trim();
        const senha = document.getElementById("reg-pass").value.trim();
        const statusEl = document.getElementById("status-cadastro");
        statusEl.innerText = "Enviando...";

        // 1. Cadastra o usuário no sistema de Auth do Supabase
        const { data: authData, error: authError } = await _supabase.auth.signUp({
            email: email,
            password: senha,
        });

        if (authError) {
            statusEl.innerText = "Erro no cadastro: " + authError.message;
            return;
        }

        // 2. Se o Auth foi sucesso, insere os dados do perfil na sua tabela "membros"
        if (authData.user) {
            const { error: dbError } = await _supabase
                .from('membros')
                .insert([
                    { 
                        id: authData.user.id, // Vincula o ID do Auth ao perfil
                        usuario: usuario, 
                        email: email, 
                        aprovado: false // Começa como falso, o admin aprova depois do PIX
                    },
                ]);

            if (dbError) {
                statusEl.innerText = "Erro ao salvar perfil. Contate o suporte.";
                // Opcional: deletar o usuário do Auth se a inserção falhar
                return;
            }

            statusEl.innerText = "Cadastro enviado com sucesso! Aguardando aprovação do PIX.";
            statusEl.style.color = "#00ff00";
            formCad.reset(); // Limpa o formulário após sucesso
            switchTab(null, 'tab-login'); // Volta para a aba de login
        }
    };
</script>
</body>
</html>
